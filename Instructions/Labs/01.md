# Exercise 1: Deploying Azure Sentinel and Onboarding Cloud Resources and Servers

### Duration: 1 hour

## Scenario 

Contoso is a global organization with a complex IT infrastructure that includes a combination of on-premises data centers and cloud-based resources. They are looking to enhance their security posture by deploying Azure Sentinel, Microsoft's cloud-native security information and event management (SIEM). As part of this initiative, Contoso aims to onboard its cloud resources and servers to Azure Sentinel to gain better visibility and proactive threat detection and response capabilities.

## Overview

A Log Analytics workspace is a unique environment for logging data from Azure Monitor and other Azure services, such as Microsoft Sentinel and Microsoft Defender for Cloud. Each workspace has its own data repository and configuration but might combine data from multiple services. You can find more references about the Log Analytics Workspace here: `https://learn.microsoft.com/en-us/azure/azure-monitor/logs/log-analytics-workspace-overview`.

Microsoft Sentinel is a scalable, cloud-native solution that provides:

  - Security information and event management (SIEM)
  - Security orchestration, automation, and response (SOAR)

Microsoft Sentinel delivers intelligent security analytics and threat intelligence across the enterprise. With Microsoft Sentinel, you get a single solution for attack detection, threat visibility, proactive hunting, and threat response. You can find more references about the Log Analytics Workspace here: `https://learn.microsoft.com/en-us/azure/sentinel/overview`.

In this exercise, you will create a Log Analytics Workspace and integrate it will Microsoft Sentinel.

This exercise includes the following tasks:

* [Task 1: Enable Azure Sentinel](#task-1-enable-azure-sentinel)
* [Task 2: Deploy the Microsoft Sentinel Training Lab Solution](#task-2-deploy-the-microsoft-sentinel-training-lab-solution)
* [Task 3: Onboard Azure resources and servers to Azure Sentinel using data connectors](#task-3-onboard-azure-resources-and-server-to-azure-sentinel-using-data-connectors)

## Task 1: Enable Azure Sentinel

This task includes the creation of the Log Analytics Workspace and the initialization of the Microsoft Sentinel Workspace.

### Task 1.1: Create a Log Analytics Workspace

1.  In the Azure Portal, from the upper left corner select the **menu (1)** icon with three lines as highlighted below and then select **+ Create a resource (2)**.

      ![Create resource](../media/createrenew.png)

2. In the search box, type **Log Analytics Workspace** and select it from the search result.
   
      ![Search resource](../media/law.png)
   
3. Within the Marketplace page, click on **Create (1)** and select **Log Analytics Workspace (2)** from the **Log Analytics Workspace** resource card.

      ![create law](../media/marketplace_law.png)

4. On the **Basics** tab of the **Create Log Analytics workspace**, enter the following details:
   
      -  **Subscription:** Select the default assigned subscription **(1)**.
      -  **Resource group:** Select **Microsoft-Sentinel** resource group from the drop-down list **(2)**.
      -  **Name:**  Enter **contoso-diagnosticworkspace-<inject key="Deployment-id" enableCopy="false"> (3)**
      -  **Region:** Select **<inject key="Region" enableCopy="false" /> (4)**.
      -  Click on **Review + Create (5)**.

      ![create law](../media/loganalytics.png)

5. Review the configuration of the analytics workspace and select **Create**.

   ![](../media/createlog.png)
   
7. Soon after the successful deployment of the **Microsoft.LogAnalyticsOMS**, on the overview page, click on **Go to resource** to view the newly created Log Analytics Workspace.

      ![view law](../media/gotoresource_law.png)

### Task 1.2: Initialize the Microsoft Sentinel Workspace

1. In the search bar of the Azure portal, type **Sentinel** **(1)** and select **Microsoft Sentinel** **(2)** from the list of search results.

      ![search sentinel](../media/search_sentinel.png)

2. Within the Microsoft Sentinel home page, click on **+ Create** to create and configure the Sentinel Workspace.

      ![create sentinel](../media/create_sentinel.png)

3. On the **Add Microsoft Sentinel to a Workspace** page, select the existing workspace i.e., **log-contoso-diagnosticworkspace-<inject key="Deployment-id" enableCopy="false"> (1)** which was created in the previous task, then select **Add (2)**. This could take a few minutes.

      ![add workspace](../media/addlaw.png)

4. Navigate around the newly created Microsoft Sentinel workspace to become familiar with the user interface options.

    ![](../media/sentinelpage.png)
   
   >**Note**: The Microsoft Sentinel is deployed with a one-month free trial activation period. If you get a pop-up saying the **Microsoft Sentinel free trial activated**, click on **Ok**.

     ![](../media/freetrailactivated.png)

## Task 2: Deploy the Microsoft Sentinel Training Lab Solution

This task includes the deployment of the Training Lab solution into the existing workspace. This will ingest pre-recorded data (~20 MB) and create several other artifacts that will be used during the exercises.

1. In the Azure Portal, go to the global search bar and type **Microsoft Sentinel Training (1)**. Click on the **Microsoft Sentinel Training Lab Solution (2)** marketplace item.

    ![search training lab solution](../media/search_training-lab-soln.png)

2. Read the solution description in the overview tab and click on **Create**.

    ![create training lab solution](../media/create_training-lab-soln.png)

3. On the **Basics** tab of the **Create Microsoft Sentinel Training Lab Solution**, enter the following details: 
   
      -  **Subscription:** Select the default assigned subscription **(1)**.
      -  **Resource group:** Select **Microsoft-Sentinel** resource group from the drop-down list **(2)**.
      -  **Workspace:** Select **contoso-diagnosticworkspace-<inject key="Deployment-id" enableCopy="false"> (3)**.
      -  Click on **Review + Create (4)**.
  
    ![configure training lab solution](../media/configure_training-lab-soln.png)

4. Review the configuration of the Microsoft Sentinel Training Lab Solution and select **Create**.

    ![](../media/validate&create_training-lab-soln.png)

   >**Note**: The deployment of the Microsoft Sentinel Training Lab Solution takes about **15 minutes**, so all the ingested data is ready to use once finished.

5. Once the deployment is successful, go back to the Microsoft Sentinel resource that was deployed in the previous task. On the **Microsoft Sentinel | Overview (Preview)** page, notice that there is some ingested data and several recent incidents.

    ![Sentinel overview page](../media/sentinel-overview-page.png)

    >**Note**: Don't worry if you do not see the incidents initially as in the screenshot above, they might take up to 5 minutes to be raised. You can continue with the execution of the following tasks.

## Task 3: Onboard Azure resources and servers to Azure Sentinel using data connectors

This task includes the establishment of a connection between Windows and M365 data in the Sentinel workspace.

### Task 3.1: Connect an Azure Windows Virtual Machine to Microsoft Sentinel

1. In the search bar of the Azure portal, type **Sentinel (1)**, then select **Microsoft Sentinel (2)**.

    ![search sentinel](../media/selectsentinel.png)

2. Select the Log Analytics Workspace that was created in the previous step.

    ![select sentinel-law](../media/select-sentinel-law.png)
 
3. On the Microsoft Sentinel page, follow the below instructions to install the data connector:

     - Click on **Content hub (1)** from the left navigation pane.
     - Search for **Windows Security Events (2)** from the search bar and select it **(3)**.
     - Click on **Install (4)** on the right navigation page that shows up.
    
    ![Install Windows Security Events](../media/windows_security_events.png)

      >**Note**: The installation may take up to a minute. Wait for the **Install Success** notification, after which you can now notice the **Installed** count has increased to **2**.

    ![Installed count](../media/installed-2.png)

4. To configure **Windows Security Events via the AMA** data connector, perform the below steps:

    - From the left navigation pane, click on **Data connectors (1)** under the **Configuration** section.
    - Select the **Windows Security Events via AMA (2)** connector from the available list.
    - Click on **Open Connector Page (3)** from the right navigation pane.

   ![Windows Security Events - Data connectors](../media/windows_security_events-connection.png)

5. In the Configuration section of the **Windows Security Events via AMA** page, click on the **+Create data collection rule**.

      ![Create DCR for Windows Security events via AMA connector](../media/create_dcr.png)

6. On the **Basics** tab of the **Create Data Collection Rule** pane, enter the following details:

      -  **Rule Name**: **windows-security-events-dcr** **(1)**
      -  **Subscription:** Select the **default assigned subscription (2)**.
      -  **Resource group:** Select **Microsoft-Sentinel** resource group from the drop-down list **(3)**.
      -  Select **Next: Resources >** **(4)**

      ![Create DCR for Windows Security events via AMA connector](../media/datacollection.png)

7. Under the **Resources** tab, select **+Add resource(s)**.

      ![Add resources](../media/add_resources.png)

8. On the **Browse** tab of the **Select a scope** page, perform the following steps:

      - Expand the resource group **Microsoft-Sentinel (1)**
      - Select the Windows virtual machine named **labvm-<inject key="Deployment-id" enableCopy="false"> (2)**
      - Click on **Apply (3)**.

      ![select resource](../media/selectscope.png)

      >**Note**: This lab is provided with a pre-created Windows virtual machine (for the ease of the users), which can be added as a resource to connect with Microsoft Sentinel.

9. On **Create Data Collection Rule** page, click on **Next : Collect >**.

    ![](../media/collect.png)

10. On the **Collect** page, follow the below instructions:

     - **Select which events to stream:** Select **All Security Events (1)**
     - Click on **Next : Review + Create> (2)**.
   
      ![](../media/collect1.png)

11. Review the configuration and click on **Create**.

    ![](../media/createdcr.png)
   
      >**Note**: Wait for the **successfully installed extension** notification within the Azure portal implying that the DCR has been created along with the AMA being installed successfully. Select **Refresh** to see the new data collection rule listed.

12. On the **Microsoft Sentinel | Data connectors** page, notice that now the **Windows Security Events via AMA** data connector is successfully connected with Microsoft Sentinel.

      ![windows_security_events data connector connected](../media/connected-2.png)

### Task 3.2: Connect M365 data to Sentinel using Data connectors

1. In the search bar of the Azure portal, type **Sentinel (1)**, then select **Microsoft Sentinel (2)**.

      ![search sentinel](../media/search_sentinel.png)

2. Select the Log Analytics Workspace that was created in the previous step.

    ![select sentinel-law](../media/select-sentinel-law.png)
 
3. Within the Microsoft Sentinel page, execute the following steps to install the **Microsoft 365** solution:

    - Click on **Content hub (1)** under the **Content management** section from the left navigation pane.
    - Search **Microsoft 365 (2)** solution from the search bar.
    - Select **Microsoft 365 (3)** from the list of search results.
    - Click on the **Install (4)** button in the right navigation pane.

   ![Install Microsoft 365](../media/m365-install.png)

      >**Note**: The installation may take up to a minute. Wait for the **Install Success** notification after which you can notice that the **Installed** count has been increased to **3**.

   ![Installed M365 solution](../media/installed-3.png) 

6. From the **Data Connectors** tab, under the **Configuration** section in the left navigation pane of the Microsoft Sentinel page, select the **Microsoft 365 (1)** connector from the available list and click on **Open connector page (2)** from the right navigation pane.

      >**Note**: You might have to refresh the Microsoft | Data connectors page to view the Microsoft 365 connector.

   ![M365 - Data connectors](../media/m365-connection.png)

7. In the Configuration section of the **Microsoft 365** page, ensure to select all three check boxes **(1)** analogous to **Exchange**, **SharePoint**, and **Teams** respectively. Click on **Apply Changes (2)**.

      ![Configure M365 connector](../media/configure-m365.png)

   >**Note**: This lab is provided with required read/write access to the Sentinel workspace, along with the tenant having Security Administrator permissions to pre-handily meet the prerequisites for successfully connecting data connectors.

8. Upon receiving the *Success* notification (which can be viewed from the notifications panel) within the Azure portal, it implies that the Microsoft 365 data connector has been successfully connected with Microsoft Sentinel. This can also be validated by the change in the status to **Connected** as shown in the below screenshot:

      ![m365-connected](../media/m365-connected.png)
